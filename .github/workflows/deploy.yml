name: ğŸš€ Deploy xtai-nav-app to ECS

on:
  push:
    branches:
      - deploy # æ¨é€åˆ° deploy åˆ†æ”¯è‡ªåŠ¨éƒ¨ç½²

jobs:
  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Deploy on Remote ECS
        env:
          PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          HOSTNAME: ${{ secrets.SSH_HOST }}
          USER_NAME: ${{ secrets.SSH_USER }}

        run: |
          echo "$PRIVATE_KEY" > private_key && chmod 600 private_key

          ssh -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${HOSTNAME} "
            set -e
            echo 'â¡ï¸ è¿›å…¥éƒ¨ç½²ç›®å½•...'
            cd ~/xtai-nav-app || mkdir -p ~/xtai-nav-app && cd ~/xtai-nav-app

            echo 'ğŸ“¦ æ‹‰å–æœ€æ–°ä»£ç ...'
            if [ ! -d .git ]; then
              git clone -b deploy git@github.com:${{ github.repository }} .
            else
              git fetch origin deploy && git reset --hard origin/deploy
            fi

            echo 'ğŸ³ åœæ­¢æ—§å®¹å™¨...'
            docker stop xtai-nav-app || true
            docker rm xtai-nav-app || true

            echo 'ğŸ§¹ åˆ é™¤æ—§é•œåƒ...'
            docker rmi xtai-nav-app || true

            echo 'ğŸ§± æ„å»ºæ–°é•œåƒ...'
            docker build -t xtai-nav-app .

            echo 'ğŸš€ å¯åŠ¨å®¹å™¨...'
            docker run -d \
              --name xtai-nav-app \
              -p 3000:3000 \
              xtai-nav-app

            echo 'âœ… éƒ¨ç½²å®Œæˆï¼'
          "

          rm -f private_key
